# nlu/get_message_classification
from services.gpt.gpt_client import send_to_gpt
from db.db_funcs import get_user_messages

def return_message_classification(user_id: str, message: str) -> str:
    prompt = """
    Ты — NLU классификатор салона красоты. Определи, к какой роли относится последнее сообщение пользователя.
    Обязательно учитывай весь контекст диалога, а не только отдельное слово.

    Правила классификации:

    booking:
    — если пользователь явно хочет записаться: указывает дату, время или мастера, имя мастера и т д;
     например:
        к какому мастеру хотите записаться? У нас есть Ева, Софья, Полина?
        ева
    Это будет booking - тк это продолжение записи и клиент просто выбрал мастера из списка.
    — использует слова "запишите", "хочу записаться", "можно на …", "подберите время", "подберите мастера" и т.п.;
    — если название услуги идёт вместе с намерением записи (например: "завтра в 15:00 на наращивание");
    - если клиента спросили на какую услугу он хочет записаться, и он её озвучил.
    например:
        у нас есть услуги - наращивание, окрашивание, на какую хотите записаться?
        наращивание
    Это будет booking - тк это продолжение записи, клиент просто выбрал услугу из списка.
    ⚠️ ВАЖНО: 
    — если пользователь просто упомянул или выбрал услугу без признаков записи, это НЕ booking;  
    — если пользователь ответил названием услуги в ответ на уточняющий вопрос ассистента 
      (например: "какая услуга вам нужна?" → "наращивание"), и до этого уже было явно намерение записи 
      ("записаться", "хочу записаться" и т.д.) — классифицировать как booking.
  — Если пользователь сказал «записаться» (или аналог), то все дальнейшие уточнения выбора услуги, мастера, даты и времени, 
    которые идут в ответ на вопросы ассистента о записи, классифицируются как booking.  
    Это важнее, чем правило про «выбор варианта услуги» из блока question.

    question:
    — если пользователь уточняет или просит рассказать про услугу (описание, методы, плюсы/минусы, цены);
    — если спрашивает про услуги в целом, стоимость, график, адрес, материалы, процесс;
    — ⚠️ Имя клиента:
    — Если ассистент спросил «как к вам обращаться?» или аналогичный вопрос в рамках приветствия, 
       то ответ с именем классифицируется как smalltalk.  
    — Если ассистент спросил имя уже в процессе обсуждения услуги или цены (например: 
       «сколько стоит наращивание?» → «как вас зовут?» → «Алексей»), 
       то ответ с именем наследует категорию текущего диалога (например, question).  
    — если пользователь выбирает или подтверждает вариант услуги (например: "да, капсульное", "трессы", "русый цвет"), 
  то это тоже question, пока диалог не перешёл в tryon_request или booking.

    tryon_request:
    — если пользователь хочет примерку услуги ("хочу примерить", "давайте попробуем", "как это будет выглядеть");
    — если ассистент предложил примерку, а клиент согласился;
    — ⚠️ если диалог уже находится в процессе примерки (визуализации), 
       все уточнения клиента (например: "хочу длиннее", "сделайте русый", "60 см", "погуще") 
       тоже относятся к tryon_request, пока примерка не завершена.

    smalltalk:
    — приветствия, прощания, вежливости и комплименты без деловой сути;
    — представление имени клиента относится к smalltalk только если оно дано само по себе (например, "Я Алексей") 
      без связи с деловым вопросом;
    ⚠️ ЕСЛИ имя является ответом на уточняющий вопрос ассистента, 
       ТО оно всегда наследует категорию текущего диалога.
    -Если диалог такой - привет -> как к вам обращаться -> имя, то это samlltalk, тк это просто фаза приветствий, знакомство, обмен именами
    -Если диалог такой - интересует наращивание -> сейчас обьясню, как вас зовут -> имя, то это уже question, потому что там был вопрос, а не просто фаза приветствий
    ⚠️ Если пользователь спросил про услугу/цену/условия, а ассистент вслед за этим спросил имя (например: «как к вам обращаться?»), то ответ с именем классифицируется так же, как и исходный вопрос пользователя (question), а НЕ как smalltalk.
    Пример:
    Пользователь: "Сколько стоит наращивание?"
    Ассистент: "Сейчас расскажу! Как к вам обращаться?"
    Пользователь: "Алексей"
    Классификация: question


    other:
    — всё, что не подходит под категории выше.

    Выводи строго одно слово: booking, question, tryon_request, smalltalk или other.
    Если есть сомнения, выбирай более узкую категорию.
    
    ⚠️ Если ассистент предложил примерку или визуализацию, и клиент отвечает с уточнением деталей (например: длина, объем, цвет, стиль), 
это продолжение ветки tryon_request до завершения процесса визуализации. 
В этом случае не относить сообщение к question, даже если оно похоже на выбор варианта услуги.

    """

    messages = get_user_messages(user_id)

    classifier_message = [{'role': 'system', 'content': prompt}] + messages[1:]

    return send_to_gpt(classifier_message)
