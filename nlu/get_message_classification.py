# nlu/get_message_classification
from services.gpt.gpt_client import send_to_gpt
from db.db_funcs import get_user_messages

def return_message_classification(user_id: str, message: str) -> str:
    prompt = """
    Ты — NLU классификатор салона красоты. Определи, к какой роли относится последнее сообщение пользователя.
    Обязательно учитывай весь контекст диалога, а не только отдельное слово.

    Правила классификации:

    booking:
    — если пользователь явно хочет записаться: указывает дату, время или мастера;
    — использует слова "запишите", "хочу записаться", "можно на …", "подберите время", "подберите мастера" и т.п.;
    — если название услуги идёт вместе с намерением записи (например: "завтра в 15:00 на наращивание");
    ⚠️ ВАЖНО: если пользователь просто упомянул или выбрал услугу без признаков записи, это НЕ booking.

    question:
    — если пользователь уточняет или просит рассказать про услугу (описание, методы, плюсы/минусы, цены);
    — если спрашивает про услуги в целом, стоимость, график, адрес, материалы, процесс;
    — ⚠️ если пользователь назвал своё имя как ответ на вопрос ассистента в контексте обсуждения услуги/цены —
       относить это сообщение тоже к question (оно наследует тему текущего диалога).
    — если пользователь выбирает или подтверждает вариант услуги (например: "да, капсульное", "трессы", "русый цвет"), 
  то это тоже question, пока диалог не перешёл в tryon_request или booking.

    tryon_request:
    — если пользователь хочет примерку услуги ("хочу примерить", "давайте попробуем", "как это будет выглядеть");
    — если ассистент предложил примерку, а клиент согласился;
    — ⚠️ если диалог уже находится в процессе примерки (визуализации), 
       все уточнения клиента (например: "хочу длиннее", "сделайте русый", "60 см", "погуще") 
       тоже относятся к tryon_request, пока примерка не завершена.

    smalltalk:
    — приветствия, прощания, вежливости и комплименты без деловой сути;
    — представление имени клиента относится к smalltalk только если оно дано само по себе (например, "Я Алексей") 
      без связи с деловым вопросом;
    ⚠️ ЕСЛИ имя является ответом на уточняющий вопрос ассистента, 
       ТО оно всегда наследует категорию текущего диалога (чаще всего — question).
       
    other:
    — всё, что не подходит под категории выше.

    Выводи строго одно слово: booking, question, tryon_request, smalltalk или other.
    Если есть сомнения, выбирай более узкую категорию.
    
    ⚠️ Если ассистент предложил примерку или визуализацию, и клиент отвечает с уточнением деталей (например: длина, объем, цвет, стиль), 
это продолжение ветки tryon_request до завершения процесса визуализации. 
В этом случае не относить сообщение к question, даже если оно похоже на выбор варианта услуги.

    """

    messages = get_user_messages(user_id)

    classifier_message = messages[1:-1] + [{'role': 'system', 'content': prompt}] + [messages[-1]]

    return send_to_gpt(classifier_message)
