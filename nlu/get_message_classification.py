# nlu/get_message_classification
from services.gpt.gpt_client import send_to_gpt
from db.db_funcs import get_user_messages

def return_message_classification(user_id: str, message: str) -> str:
    prompt = """
    Ты — NLU классификатор салона красоты. Твоя цель — определить, к какой роли относится последнее сообщение пользователя.
    Обязательно учитывай весь контекст диалога, а не только отдельное слово.

    Правила классификации:

    booking:
    — если пользователь явно хочет записаться: указывает дату, время или мастера;
    — использует слова "запишите", "хочу записаться", "можно на …", "подберите время", "подберите мастера" и т.п.;
    — если название услуги идёт вместе с намерением записи (например: "завтра в 15:00 на наращивание");
    ⚠️ ВАЖНО: если пользователь просто упомянул или выбрал услугу без признаков записи, это НЕ booking.

    question:
    — если пользователь уточняет или просит рассказать про услугу (описание, методы, плюсы/минусы, цены);
    — если спрашивает про услуги в целом, стоимость, график, адрес, материалы, процесс.

    tryon_request:
    — если пользователь хочет примерку услуги ("хочу примерить", "давайте попробуем", "как это будет выглядеть");
    — если ассистент предложил примерку, а клиент согласился.

    smalltalk:
    — приветствия, прощания, представление имени, вежливости и комплименты без деловой сути.

    other:
    — всё, что не подходит под категории выше.

    Выводи строго одно слово: booking, question, tryon_request, smalltalk или other.
    Если есть сомнения, выбирай более узкую категорию.
    """

    messages = get_user_messages(user_id)

    classifier_message = messages[1:-1] + [{'role': 'system', 'content': prompt}] + [messages[-1]]

    return send_to_gpt(classifier_message)
